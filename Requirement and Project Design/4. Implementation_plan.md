# InEight Document AI Chatbot MVP - Implementation Plan

# Goal Description
Build an MVP consisting of two integrated components:
1. **Document Management System (DMS)**: Manage projects, users, and documents with comprehensive metadata (26+ fields)
2. **AI Chatbot**: Natural language search over document metadata, linked items (RFIs, Transmittals), and document actions

The system uses Microsoft technologies (.NET 8, Azure OpenAI, Azure AI Search) and React/Tailwind for the chat widget.

## User Review Required
> [!IMPORTANT]
> **Azure Cost Considerations**: 
> - **Azure OpenAI** and **Azure AI Search** are paid services
> - For development, consider using Free Tier Azure AI Search (50MB limit)
> - Alternative: PostgreSQL with pgvector for local development
> - Estimated monthly cost: ~$100-150 for production

> [!NOTE]
> **Two-Part MVP Scope**:
> 1. Standalone DMS for testing (optional, can use existing InEight Document)
> 2. AI Chatbot integration (core MVP deliverable)

## Proposed Changes

The project will be built in `d:\\Code\\ineight\\projects\\InEightDocumentAISuite`.

---

### Phase 1: Project Scaffolding & Database Setup

#### [NEW] [InEightDocBot.sln](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.sln)
- Solution containing all projects

#### [NEW] [InEightDocBot.Service](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Program.cs)
- .NET 8 Web API (AI Microservice)
- NuGet Packages:
  - `Azure.AI.OpenAI`
  - `Azure.Search.Documents`
  - `Microsoft.EntityFrameworkCore.SqlServer`
  - `Microsoft.AspNetCore.Authentication.JwtBearer`

#### [NEW] [InEightDocBot.Widget](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Widget/package.json)
- React + Vite + Tailwind CSS
- Standalone chat widget (bundles to single JS file)

#### [NEW] [Database Migrations](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Data/Migrations/)
Create EF Core migrations for enhanced schema:

**Documents Table** (26+ fields):
- Core: `Id`, `ProjectId`, `Name`, `Description`, `Type`, `Category`, `Tags`
- Upload: `UploadedBy`, `UploadedAt`, `UploadLocation`, `UpdatedBy`, `UpdatedAt`
- Workflow: `Status`, `TransmittalNumber`, `Version`, `RevisionNumber`
- Assignment: `ManagerId`, `AssignedUserId`
- Approval: `ApprovalStatus`, `ApprovedBy`, `ApprovedAt`, `ApprovalComment`

**New Tables**:
- `DocumentLinks`: Document-to-document relationships
- `DocumentRevisions`: Version history tracking
- `LinkedItems`: RFIs, Transmittals, Mail, Forms, Tasks
- `DocumentActions`: All actions performed (updates, reviews, Bluebeam, etc.)
- `FailedQueries`: Log unsupported chatbot queries for analysis

---

### Phase 2: Enhanced Metadata Indexing

#### [NEW] [MetadataSyncService.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Services/MetadataSyncService.cs)
- Connects to existing SQL Server (via VPN/Hybrid Connection or Metadata Export API)
- Reads all 26 document metadata fields
- Formats for indexing: "Document 'Safety Protocol v2.1' (IFC) created by 'John Doe' on '2024-01-15', Status: 'Approved', Manager: 'Jane Smith', Transmittal: TX-001"
- Pushes to Azure AI Search index with user security fields

#### [NEW] [LinkedItemsSyncService.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Services/LinkedItemsSyncService.cs)
- Syncs RFIs, Transmittals, Mail responses, Forms, Tasks
- Format: "Document 'Contract Rev 3' has open RFI #RFI-2024-001 created by 'Mike Johnson' on '2024-01-10'"
- Links items to documents for compound queries

#### [NEW] [DocumentActionsSyncService.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Services/DocumentActionsSyncService.cs)
- Tracks all document actions:
  - Updates via "Change Document Details"
  - Reviews via "Bluebeam"
  - File operations: "Replace View Files", "Remove View Files"
- Enables action-based queries: "Show documents updated using Bluebeam"

#### [NEW] [IndexingOrchestrator.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Services/IndexingOrchestrator.cs)
- Coordinates all sync services
- Runs on schedule (Hosted Service with Timer)
- Implements delta sync for efficiency

---

### Phase 3: Enhanced AI & Chat Logic

#### [NEW] [ChatController.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Controllers/ChatController.cs)
Endpoints:
- `POST /api/chat/message`: Main chat endpoint
  - Input: `{ query, projectId, sessionId }`
  - Output: Structured response with links
- `POST /api/chat/generate-link`: Generate filtered document register URL
- `GET /api/chat/sessions/{userId}`: Get user's chat history

#### [NEW] [RAGOrchestrator.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Services/RAGOrchestrator.cs)
Enhanced RAG pipeline:
1. **Query Understanding**: Use Azure OpenAI to parse intent
   - Extract: query type, filters, entities
   - Example: "Show IFC drawings uploaded today" → type=search, status=IFC, date=today
2. **Multi-Source Retrieval**:
   - Search document metadata index
   - Search linked items index
   - Search document actions index
   - Apply user security filters
3. **Context Assembly**: Combine results
4. **Response Generation**: Generate natural language answer
5. **Link Generation**: Create document links or filtered view URLs
6. **Confidence Scoring**: Rate answer quality (0-1)

#### [NEW] [ResponseGenerator.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Services/ResponseGenerator.cs)
- Generates structured responses:
```json
{
  "answer": "Found 3 IFC drawings uploaded today.",
  "links": [
    {
      "type": "document",
      "id": 456,
      "title": "Structural Plan Sheet 1",
      "url": "/documents/456"
    },
    {
      "type": "filtered_view",
      "description": "All IFC drawings uploaded today",
      "url": "/documents?status=IFC&date=2024-01-18&project=123"
    }
  ],
  "confidence": 0.92,
  "fallbackKBLink": null
}
```

#### [NEW] [KnowledgeBaseService.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Services/KnowledgeBaseService.cs)
- Integrates with InEight Knowledge Base
- Maps query topics to KB articles
- Returns specific KB links for failed queries
- Logs failed queries to `FailedQueries` table for product team review

#### [NEW] [SecurityFilterService.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Services/SecurityFilterService.cs)
- Validates user access based on JWT claims
- Filters search results to only accessible documents
- Generates "Document exists but not accessible" responses with project context

---

### Phase 4: Chat Widget Development

#### [NEW] [ChatWidget Component](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Widget/src/components/ChatWidget.tsx)
Features:
- **Floating Action Button**: Bottom-right corner
- **Chat Interface**:
  - Natural language input with placeholder suggestions
  - Rich message rendering:
    - Document link cards with preview
    - "Open in Document Register" buttons for filtered views
    - KB link suggestions for failed queries
  - Chat history with session management
- **Response Handling**:
  - Clickable document links (opens in new tab or modal)
  - Filtered view buttons (navigates to document register with filters)
  - KB links displayed prominently for learning

#### [NEW] [API Client](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Widget/src/services/apiClient.ts)
- Handles JWT authentication
- Calls `/api/chat/message` endpoint
- Manages WebSocket connection for real-time responses (optional)

#### [NEW] [Build Configuration](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Widget/vite.config.ts)
- Bundles to single `chat-widget.js` file
- Scoped CSS (no conflicts with legacy styles)
- Tree-shaking and minification

---

### Phase 5: Integration & Embedding

#### [NEW] [JWT Integration](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDocBot.Service/Middleware/JwtAuthMiddleware.cs)
- **Legacy App**: Generates JWT with shared secret
- **JWT Claims**: `UserId`, `Roles`, `ProjectIds`, `AccessibleDocuments[]`
- **AI Service**: Validates JWT signature and extracts user context

#### [NEW] [Embed Script Template](file:///d:/Code/ineight/projects/InEightDocumentAISuite/embed-snippet.html)
```html
<!-- Add to Legacy App Master Page -->
<script src="https://ineightbot.azurewebsites.net/chat-widget.js"></script>
<script>
  window.InEightBot.init({ 
    token: "@Model.GeneratedJWT",
    apiUrl: "https://ineightbot.azurewebsites.net/api"
  });
</script>
```

---

### Phase 6: Deployment & CI/CD

#### [NEW] [azure-pipelines.yml](file:///d:/Code/ineight/projects/InEightDocumentAISuite/azure-pipelines.yml)
Build pipeline:
1. **API Build**:
   - `dotnet restore`
   - `dotnet build`
   - `dotnet publish`
2. **Widget Build**:
   - `npm install`
   - `npm run build`
3. **Deploy**:
   - Publish API to Azure App Service
   - Publish widget to Azure Static Web Apps or CDN

#### [RUN] Provision Azure Resources
```bash
# Create Resource Group
az group create --name InEightDocBotRG --location eastus

# Create App Service Plan (B1 for production, F1 for dev)
az appservice plan create --name InEightDocBotPlan --resource-group InEightDocBotRG --sku B1

# Create Web App
az webapp create --name ineightbot --resource-group InEightDocBotRG --plan InEightDocBotPlan

# Create Azure SQL Database
az sql server create --name ineightdocbot-sql --resource-group InEightDocBotRG --admin-user sqladmin
az sql db create --name InEightDocBotDB --server ineightdocbot-sql --service-objective S0

# Create Azure AI Search
az search service create --name ineightdocbot-search --resource-group InEightDocBotRG --sku basic

# Configure Hybrid Connection (for on-prem SQL access)
az webapp hybrid-connection add --name ineightbot --resource-group InEightDocBotRG --namespace <relay-namespace> --hybrid-connection <connection-name>
```

---

## Verification Plan

### Automated Tests

#### 1. Backend Unit Tests
```bash
dotnet test
```
Test coverage:
- `MetadataSyncService`: Mock SQL, verify index format
- `RAGOrchestrator`: Mock Azure Search, verify query parsing
- `ResponseGenerator`: Verify link generation logic
- `SecurityFilterService`: Verify access control
- `KnowledgeBaseService`: Verify KB link mapping

#### 2. Integration Tests
- Test full RAG pipeline with in-memory DB
- Test JWT validation
- Test user security filtering

#### 3. Frontend Tests
```bash
npm test
```
- Unit tests for React components
- Integration tests for API client

### Manual Verification

#### 1. Metadata Indexing Verification
- **Action**: Trigger `/api/admin/sync-metadata`
- **Verify**: Open Azure AI Search Explorer
  - Check indexed documents have all 26 fields
  - Verify sample document: "Safety Protocol v2.1, Status: IFC, Transmittal: TX-001"

#### 2. Linked Items Indexing
- **Action**: Trigger `/api/admin/sync-linked-items`
- **Verify**: Search for "documents with open RFIs"
  - Should return documents with `LinkedItems.ItemType=RFI` and `ItemStatus=Open`

#### 3. Document Actions Indexing
- **Action**: Trigger `/api/admin/sync-actions`
- **Verify**: Search for "documents reviewed using Bluebeam"
  - Should return documents with `DocumentActions.ToolUsed=Bluebeam`

#### 4. Chat Accuracy Tests
Test queries:
1. **Basic Metadata**: "Show me IFC drawings"
   - **Expected**: Documents with Status=IFC
2. **Date Filter**: "Documents uploaded today"
   - **Expected**: Documents with UploadedAt=Today
3. **Linked Items**: "Show documents with open RFIs"
   - **Expected**: Documents linked to RFIs with Status=Open
4. **Action-Based**: "Which documents were updated using Bluebeam?"
   - **Expected**: Documents with DocumentActions.ToolUsed=Bluebeam
5. **User Query**: "Who uploaded document X?"
   - **Expected**: User name from UploadedBy field
6. **Access Control**: User U1 asks about Project B document
   - **Expected**: "Document exists but not accessible. Belongs to Project B."

#### 5. Response Format Verification
- **Verify**: Response includes:
  - Natural language answer
  - Document links (clickable)
  - Filtered view URLs
  - Confidence score
  - KB link (for failed queries)

#### 6. Knowledge Base Integration
- **Action**: Ask unsupported query: "How do I configure email notifications?"
- **Verify**: Response includes:
  - "I don't have information about that"
  - KB link: https://learn.ineight.com/Document_Enhanced/Content/...
  - Query logged in `FailedQueries` table

#### 7. Security Testing
- **Test**: User U1 (assigned to Project A) queries:
  - "Show all documents" → Should only see Project A documents
  - "Show Project B documents" → Should see "Not accessible" message
- **Verify**: JWT claims are respected

#### 8. Widget Integration
- **Action**: Embed widget in test HTML page
- **Verify**:
  - FAB appears bottom-right
  - Chat opens on click
  - Natural language input works
  - Document links open correctly
  - Filtered view buttons navigate properly
  - KB links display for failed queries

#### 9. Deployment Verification
- **Action**: Push code to Azure DevOps
- **Verify**:
  - Pipeline triggers automatically
  - Build succeeds
  - Tests pass
  - Deployment completes
- **Action**: Open App Service URL
- **Verify**:
  - API health endpoint returns 200
  - Widget loads
  - Chat functionality works
  - Azure AI Search connection works
  - Azure OpenAI connection works

---

## Implementation Order

### Sprint 1: Foundation (Week 1)
1. Project scaffolding
2. Database schema with all tables
3. EF Core migrations
4. Basic API structure

### Sprint 2: Indexing (Week 2)
1. MetadataSyncService (26 fields)
2. LinkedItemsSyncService
3. DocumentActionsSyncService
4. IndexingOrchestrator
5. Azure AI Search index setup

### Sprint 3: AI Core (Week 3)
1. RAGOrchestrator (query understanding + retrieval)
2. ResponseGenerator (link generation)
3. SecurityFilterService
4. ChatController

### Sprint 4: Advanced Features (Week 4)
1. KnowledgeBaseService
2. Failed query logging
3. Confidence scoring
4. Response format refinement

### Sprint 5: Widget (Week 5)
1. React chat component
2. Rich response rendering
3. Document link handling
4. KB link display
5. Build & bundle configuration

### Sprint 6: Integration & Testing (Week 6)
1. JWT integration
2. Embed script
3. Security testing
4. End-to-end testing
5. Performance optimization

### Sprint 7: Deployment (Week 7)
1. Azure resource provisioning
2. CI/CD pipeline setup
3. Hybrid connection configuration
4. Production deployment
5. Monitoring setup
