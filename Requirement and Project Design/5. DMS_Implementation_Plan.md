# InEight Document Management System (DMS) - Implementation Plan

## Goal Description

Build the **Document Management System (DMS)** as the legacy system foundation for the InEight Document AI Suite. This DMS mimics the real InEight Document system using **.NET Framework 4.8.1** with **ASP.NET MVC 5** to provide an authentic legacy system that the AI Chatbot will query.

**DMS Role**: Acts as the data source for the AI Chatbot, storing all document metadata, user information, project structures, linked items (RFIs, Transmittals), and document actions.

---

## Technology Stack

| Component | Technology |
|-----------|------------|
| **Framework** | .NET Framework 4.8.1 |
| **Web Framework** | ASP.NET MVC 5 |
| **ORM** | Entity Framework 6 (Code First) |
| **Database** | SQL Server (LocalDB for dev, Azure SQL for prod) |
| **Authentication** | ASP.NET Identity 2.0 with Forms Authentication |
| **Frontend** | Razor Views, Bootstrap 5, jQuery |
| **IDE** | Visual Studio 2022 |

---

## Proposed Changes

Project location: `d:\Code\ineight\projects\InEightDocumentAISuite\InEightDMS`

---

### Phase 1: Solution Structure & Project Setup

#### [NEW] [InEightDMS.sln](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.sln)
Solution structure (Classic .NET Framework):
```
InEightDMS.sln
├── InEightDMS.Web (ASP.NET MVC 5 - UI & Controllers)
├── InEightDMS.Domain (Domain Models, Enums)
├── InEightDMS.Data (Entity Framework 6, Repositories)
└── InEightDMS.Tests (Unit Tests - MSTest/NUnit)
```

#### [RUN] Create Solution in Visual Studio 2022

1. Open Visual Studio 2022
2. File → New → Project
3. Select **ASP.NET Web Application (.NET Framework)**
4. Configure:
   - Project name: `InEightDMS.Web`
   - Location: `d:\Code\ineight\projects\InEightDocumentAISuite\InEightDMS`
   - Solution name: `InEightDMS`
   - Framework: `.NET Framework 4.8.1`
5. Select **MVC** template with **Individual User Accounts** authentication
6. Add additional Class Library projects:
   - `InEightDMS.Domain` (.NET Framework 4.8.1 Class Library)
   - `InEightDMS.Data` (.NET Framework 4.8.1 Class Library)

#### [RUN] Install NuGet Packages

```powershell
# InEightDMS.Data
Install-Package EntityFramework -Version 6.4.4
Install-Package Microsoft.AspNet.Identity.EntityFramework -Version 2.2.3

# InEightDMS.Web
Install-Package Microsoft.AspNet.Identity.Owin -Version 2.2.3
Install-Package Microsoft.Owin.Host.SystemWeb -Version 4.2.2
Install-Package Microsoft.Owin.Security.Cookies -Version 4.2.2
Install-Package Bootstrap -Version 5.3.2
Install-Package jQuery -Version 3.7.1
```

---

### Phase 2: Domain Models (InEightDMS.Domain)

#### [NEW] [Entities/User.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Domain/Entities/User.cs)
Using ASP.NET Identity for authentication:
```csharp
using Microsoft.AspNet.Identity.EntityFramework;
using System;
using System.Collections.Generic;

namespace InEightDMS.Domain.Entities
{
    public class ApplicationUser : IdentityUser<int, ApplicationUserLogin, ApplicationUserRole, ApplicationUserClaim>
    {
        public string Name { get; set; }
        public UserRole Role { get; set; }
        public bool IsActive { get; set; } = true;
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        
        // Navigation properties
        public virtual ICollection<ProjectUser> ProjectAssignments { get; set; }
        public virtual ICollection<Project> ManagedProjects { get; set; }
        public virtual ICollection<Document> UploadedDocuments { get; set; }
        
        public ApplicationUser()
        {
            ProjectAssignments = new HashSet<ProjectUser>();
            ManagedProjects = new HashSet<Project>();
            UploadedDocuments = new HashSet<Document>();
        }
    }
    
    public class ApplicationUserLogin : IdentityUserLogin<int> { }
    public class ApplicationUserRole : IdentityUserRole<int> { }
    public class ApplicationUserClaim : IdentityUserClaim<int> { }
    public class ApplicationRole : IdentityRole<int, ApplicationUserRole> { }
    
    public enum UserRole
    {
        Admin = 1,
        ProjectManager = 2,
        ProjectUser = 3
    }
}
```

#### [NEW] [Entities/Project.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Domain/Entities/Project.cs)
```csharp
using System;
using System.Collections.Generic;

namespace InEightDMS.Domain.Entities
{
    public class Project
    {
        public int Id { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public int ManagerId { get; set; }
        public bool IsActive { get; set; } = true;
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        
        // Navigation properties
        public virtual ApplicationUser Manager { get; set; }
        public virtual ICollection<ProjectUser> ProjectUsers { get; set; }
        public virtual ICollection<Document> Documents { get; set; }
        
        public Project()
        {
            ProjectUsers = new HashSet<ProjectUser>();
            Documents = new HashSet<Document>();
        }
    }
}
```

#### [NEW] [Entities/ProjectUser.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Domain/Entities/ProjectUser.cs)
```csharp
using System;

namespace InEightDMS.Domain.Entities
{
    public class ProjectUser
    {
        public int ProjectId { get; set; }
        public int UserId { get; set; }
        public DateTime AssignedAt { get; set; } = DateTime.UtcNow;
        
        // Navigation properties
        public virtual Project Project { get; set; }
        public virtual ApplicationUser User { get; set; }
    }
}
```

#### [NEW] [Entities/Document.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Domain/Entities/Document.cs)
Document with all 26+ metadata fields from requirements:
```csharp
using System;
using System.Collections.Generic;

namespace InEightDMS.Domain.Entities
{
    public class Document
    {
        // Core Fields
        public int Id { get; set; }
        public int ProjectId { get; set; }
        public string Name { get; set; }
        public string Description { get; set; }
        public string Type { get; set; } // IFC, DWG, PDF, etc.
        public string Category { get; set; }
        public string Tags { get; set; } // Comma-separated
        
        // Upload Information
        public int UploadedById { get; set; }
        public DateTime UploadedAt { get; set; } = DateTime.UtcNow;
        public string UploadLocation { get; set; }
        
        // Update Information
        public int? UpdatedById { get; set; }
        public DateTime? UpdatedAt { get; set; }
        
        // Status & Workflow
        public DocumentStatus Status { get; set; } = DocumentStatus.Draft;
        public string TransmittalNumber { get; set; }
        
        // Version Control
        public int Version { get; set; } = 1;
        public int RevisionNumber { get; set; } = 0;
        
        // Assignment
        public int? ManagerId { get; set; }
        public int? AssignedUserId { get; set; }
        
        // Approval Workflow
        public ApprovalStatus ApprovalStatus { get; set; } = ApprovalStatus.Pending;
        public int? ApprovedById { get; set; }
        public DateTime? ApprovedAt { get; set; }
        public string ApprovalComment { get; set; }
        
        // Revision Tracking
        public DateTime? RevisionDate { get; set; }
        public string RevisionComment { get; set; }
        public RevisionStatus? RevisionStatusValue { get; set; }
        
        // File Storage Path
        public string FilePath { get; set; }
        
        // Navigation properties
        public virtual Project Project { get; set; }
        public virtual ApplicationUser UploadedBy { get; set; }
        public virtual ApplicationUser UpdatedBy { get; set; }
        public virtual ApplicationUser Manager { get; set; }
        public virtual ApplicationUser AssignedUser { get; set; }
        public virtual ApplicationUser ApprovedBy { get; set; }
        
        public virtual ICollection<DocumentLink> LinkedDocuments { get; set; }
        public virtual ICollection<DocumentRevision> Revisions { get; set; }
        public virtual ICollection<LinkedItem> LinkedItems { get; set; }
        public virtual ICollection<DocumentAction> Actions { get; set; }
        
        public Document()
        {
            LinkedDocuments = new HashSet<DocumentLink>();
            Revisions = new HashSet<DocumentRevision>();
            LinkedItems = new HashSet<LinkedItem>();
            Actions = new HashSet<DocumentAction>();
        }
    }

    public enum DocumentStatus
    {
        Draft = 1,
        InReview = 2,
        IFC = 3, // Issued for Construction
        Approved = 4,
        Superseded = 5,
        Archived = 6
    }

    public enum ApprovalStatus
    {
        Pending = 1,
        Approved = 2,
        Rejected = 3,
        RevisionRequired = 4
    }

    public enum RevisionStatus
    {
        Draft = 1,
        UnderReview = 2,
        Released = 3
    }
}
```

#### [NEW] [Entities/DocumentLink.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Domain/Entities/DocumentLink.cs)
```csharp
using System;

namespace InEightDMS.Domain.Entities
{
    public class DocumentLink
    {
        public int Id { get; set; }
        public int SourceDocumentId { get; set; }
        public int TargetDocumentId { get; set; }
        public LinkType Type { get; set; }
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        
        public virtual Document SourceDocument { get; set; }
        public virtual Document TargetDocument { get; set; }
    }

    public enum LinkType
    {
        Reference = 1,
        Supersedes = 2,
        Related = 3
    }
}
```

#### [NEW] [Entities/DocumentRevision.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Domain/Entities/DocumentRevision.cs)
```csharp
using System;

namespace InEightDMS.Domain.Entities
{
    public class DocumentRevision
    {
        public int Id { get; set; }
        public int DocumentId { get; set; }
        public int RevisionNumber { get; set; }
        public DateTime RevisionDate { get; set; } = DateTime.UtcNow;
        public string RevisionComment { get; set; }
        public RevisionStatus Status { get; set; }
        public int RevisedById { get; set; }
        public string FilePath { get; set; }
        
        public virtual Document Document { get; set; }
        public virtual ApplicationUser RevisedBy { get; set; }
    }
}
```

#### [NEW] [Entities/LinkedItem.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Domain/Entities/LinkedItem.cs)
For RFIs, Transmittals, Mail responses, Forms, Tasks:
```csharp
using System;

namespace InEightDMS.Domain.Entities
{
    public class LinkedItem
    {
        public int Id { get; set; }
        public int DocumentId { get; set; }
        public LinkedItemType ItemType { get; set; }
        public ItemStatus Status { get; set; }
        public string ItemNumber { get; set; }
        public string Title { get; set; }
        public int CreatedById { get; set; }
        public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
        public string Metadata { get; set; } // JSON for additional fields
        
        public virtual Document Document { get; set; }
        public virtual ApplicationUser CreatedBy { get; set; }
    }

    public enum LinkedItemType
    {
        RFI = 1,
        Transmittal = 2,
        Mail = 3,
        Form = 4,
        Task = 5
    }

    public enum ItemStatus
    {
        Open = 1,
        InProgress = 2,
        Closed = 3,
        Pending = 4
    }
}
```

#### [NEW] [Entities/DocumentAction.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Domain/Entities/DocumentAction.cs)
Tracks all actions on documents:
```csharp
using System;

namespace InEightDMS.Domain.Entities
{
    public class DocumentAction
    {
        public int Id { get; set; }
        public int DocumentId { get; set; }
        public ActionType Type { get; set; }
        public int ActionById { get; set; }
        public DateTime ActionAt { get; set; } = DateTime.UtcNow;
        public string ToolUsed { get; set; } // Bluebeam, etc.
        public string Details { get; set; } // JSON
        
        public virtual Document Document { get; set; }
        public virtual ApplicationUser ActionBy { get; set; }
    }

    public enum ActionType
    {
        Created = 1,
        Updated = 2,
        Reviewed = 3,
        Approved = 4,
        Rejected = 5,
        ViewFileReplaced = 6,
        ViewFileRemoved = 7,
        BluebeamReview = 8,
        DetailsChanged = 9,
        StatusChanged = 10
    }
}
```

---

### Phase 3: Data Layer (InEightDMS.Data)

#### [NEW] [DMSDbContext.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Data/DMSDbContext.cs)
Entity Framework 6 DbContext with ASP.NET Identity:
```csharp
using Microsoft.AspNet.Identity.EntityFramework;
using System.Data.Entity;
using InEightDMS.Domain.Entities;

namespace InEightDMS.Data
{
    public class DMSDbContext : IdentityDbContext<ApplicationUser, ApplicationRole, int, 
        ApplicationUserLogin, ApplicationUserRole, ApplicationUserClaim>
    {
        public DMSDbContext() : base("DMSConnection")
        {
            Configuration.LazyLoadingEnabled = true;
            Configuration.ProxyCreationEnabled = true;
        }
        
        public DbSet<Project> Projects { get; set; }
        public DbSet<ProjectUser> ProjectUsers { get; set; }
        public DbSet<Document> Documents { get; set; }
        public DbSet<DocumentLink> DocumentLinks { get; set; }
        public DbSet<DocumentRevision> DocumentRevisions { get; set; }
        public DbSet<LinkedItem> LinkedItems { get; set; }
        public DbSet<DocumentAction> DocumentActions { get; set; }
        
        protected override void OnModelCreating(DbModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);
            
            // ProjectUser composite key
            modelBuilder.Entity<ProjectUser>()
                .HasKey(pu => new { pu.ProjectId, pu.UserId });
            
            // Project -> Manager relationship
            modelBuilder.Entity<Project>()
                .HasRequired(p => p.Manager)
                .WithMany(u => u.ManagedProjects)
                .HasForeignKey(p => p.ManagerId)
                .WillCascadeOnDelete(false);
            
            // Document -> UploadedBy relationship
            modelBuilder.Entity<Document>()
                .HasRequired(d => d.UploadedBy)
                .WithMany(u => u.UploadedDocuments)
                .HasForeignKey(d => d.UploadedById)
                .WillCascadeOnDelete(false);
            
            // Document -> Project relationship
            modelBuilder.Entity<Document>()
                .HasRequired(d => d.Project)
                .WithMany(p => p.Documents)
                .HasForeignKey(d => d.ProjectId)
                .WillCascadeOnDelete(false);
                
            // DocumentLink self-referencing
            modelBuilder.Entity<DocumentLink>()
                .HasRequired(dl => dl.SourceDocument)
                .WithMany(d => d.LinkedDocuments)
                .HasForeignKey(dl => dl.SourceDocumentId)
                .WillCascadeOnDelete(false);
        }
        
        public static DMSDbContext Create()
        {
            return new DMSDbContext();
        }
    }
}
```

#### [NEW] [Repositories/DocumentRepository.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Data/Repositories/DocumentRepository.cs)
```csharp
using System.Collections.Generic;
using System.Data.Entity;
using System.Linq;
using System.Threading.Tasks;
using InEightDMS.Domain.Entities;

namespace InEightDMS.Data.Repositories
{
    public class DocumentRepository
    {
        private readonly DMSDbContext _context;
        
        public DocumentRepository(DMSDbContext context)
        {
            _context = context;
        }
        
        public async Task<Document> GetByIdAsync(int id)
        {
            return await _context.Documents
                .Include(d => d.UploadedBy)
                .Include(d => d.Project)
                .Include(d => d.LinkedItems)
                .Include(d => d.Actions)
                .FirstOrDefaultAsync(d => d.Id == id);
        }
        
        public async Task<IEnumerable<Document>> GetByProjectAsync(int projectId)
        {
            return await _context.Documents
                .Where(d => d.ProjectId == projectId)
                .Include(d => d.UploadedBy)
                .ToListAsync();
        }
        
        public async Task<Document> CreateAsync(Document document)
        {
            _context.Documents.Add(document);
            await _context.SaveChangesAsync();
            return document;
        }
        
        public async Task UpdateAsync(Document document)
        {
            _context.Entry(document).State = EntityState.Modified;
            await _context.SaveChangesAsync();
        }
    }
}
```

---

### Phase 4: Web Application (InEightDMS.Web)

#### [NEW] [Web.config Connection String](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Web/Web.config)
```xml
<connectionStrings>
  <add name="DMSConnection" 
       connectionString="Data Source=(LocalDb)\MSSQLLocalDB;Initial Catalog=InEightDMS;Integrated Security=True" 
       providerName="System.Data.SqlClient" />
</connectionStrings>
```

#### [NEW] [Controllers/AccountController.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Web/Controllers/AccountController.cs)
User registration and login with ASP.NET Identity:
```csharp
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.Owin;
using Microsoft.Owin.Security;
using System.Threading.Tasks;
using System.Web;
using System.Web.Mvc;
using InEightDMS.Domain.Entities;
using InEightDMS.Web.Models;

namespace InEightDMS.Web.Controllers
{
    public class AccountController : Controller
    {
        private ApplicationUserManager _userManager;
        private ApplicationSignInManager _signInManager;
        
        public ApplicationUserManager UserManager
        {
            get { return _userManager ?? HttpContext.GetOwinContext().GetUserManager<ApplicationUserManager>(); }
        }
        
        public ApplicationSignInManager SignInManager
        {
            get { return _signInManager ?? HttpContext.GetOwinContext().Get<ApplicationSignInManager>(); }
        }
        
        [HttpGet]
        public ActionResult Login(string returnUrl)
        {
            ViewBag.ReturnUrl = returnUrl;
            return View();
        }
        
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> Login(LoginViewModel model, string returnUrl)
        {
            if (!ModelState.IsValid)
                return View(model);
            
            var result = await SignInManager.PasswordSignInAsync(
                model.Email, model.Password, model.RememberMe, shouldLockout: false);
            
            switch (result)
            {
                case SignInStatus.Success:
                    return RedirectToLocal(returnUrl);
                default:
                    ModelState.AddModelError("", "Invalid email or password");
                    return View(model);
            }
        }
        
        [HttpGet]
        public ActionResult Register()
        {
            return View();
        }
        
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> Register(RegisterViewModel model)
        {
            if (!ModelState.IsValid)
                return View(model);
            
            // Admin cannot be registered
            if (model.Role == UserRole.Admin)
            {
                ModelState.AddModelError("", "Admin cannot be registered");
                return View(model);
            }
            
            var user = new ApplicationUser
            {
                UserName = model.Email,
                Email = model.Email,
                Name = model.Name,
                Role = model.Role
            };
            
            var result = await UserManager.CreateAsync(user, model.Password);
            
            if (result.Succeeded)
            {
                await SignInManager.SignInAsync(user, isPersistent: false, rememberBrowser: false);
                return RedirectToAction("Index", "Dashboard");
            }
            
            AddErrors(result);
            return View(model);
        }
        
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult LogOff()
        {
            HttpContext.GetOwinContext().Authentication.SignOut(DefaultAuthenticationTypes.ApplicationCookie);
            return RedirectToAction("Login");
        }
        
        private ActionResult RedirectToLocal(string returnUrl)
        {
            if (Url.IsLocalUrl(returnUrl))
                return Redirect(returnUrl);
            return RedirectToAction("Index", "Dashboard");
        }
        
        private void AddErrors(IdentityResult result)
        {
            foreach (var error in result.Errors)
                ModelState.AddModelError("", error);
        }
    }
}
```

#### [NEW] [Controllers/ProjectsController.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Web/Controllers/ProjectsController.cs)
Admin-only project management:
```csharp
using System.Linq;
using System.Threading.Tasks;
using System.Web.Mvc;
using System.Data.Entity;
using InEightDMS.Data;
using InEightDMS.Domain.Entities;
using InEightDMS.Web.Models;

namespace InEightDMS.Web.Controllers
{
    [Authorize]
    public class ProjectsController : Controller
    {
        private readonly DMSDbContext _context = new DMSDbContext();
        
        public async Task<ActionResult> Index()
        {
            var userId = User.Identity.GetUserId<int>();
            var user = await _context.Users.FindAsync(userId);
            
            IQueryable<Project> projects;
            
            if (user.Role == UserRole.Admin)
            {
                projects = _context.Projects.Include(p => p.Manager);
            }
            else
            {
                // Show only assigned projects
                var projectIds = await _context.ProjectUsers
                    .Where(pu => pu.UserId == userId)
                    .Select(pu => pu.ProjectId)
                    .ToListAsync();
                
                projects = _context.Projects
                    .Where(p => projectIds.Contains(p.Id) || p.ManagerId == userId)
                    .Include(p => p.Manager);
            }
            
            return View(await projects.ToListAsync());
        }
        
        [HttpGet]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult> Create()
        {
            var managers = await _context.Users
                .Where(u => u.Role == UserRole.ProjectManager)
                .ToListAsync();
            ViewBag.Managers = new SelectList(managers, "Id", "Name");
            return View();
        }
        
        [HttpPost]
        [ValidateAntiForgeryToken]
        [Authorize(Roles = "Admin")]
        public async Task<ActionResult> Create(ProjectCreateViewModel model)
        {
            if (!ModelState.IsValid)
            {
                var managers = await _context.Users
                    .Where(u => u.Role == UserRole.ProjectManager)
                    .ToListAsync();
                ViewBag.Managers = new SelectList(managers, "Id", "Name");
                return View(model);
            }
            
            var project = new Project
            {
                Name = model.Name,
                Description = model.Description,
                ManagerId = model.ManagerId
            };
            
            _context.Projects.Add(project);
            await _context.SaveChangesAsync();
            
            return RedirectToAction(nameof(Index));
        }
        
        protected override void Dispose(bool disposing)
        {
            if (disposing) _context.Dispose();
            base.Dispose(disposing);
        }
    }
}
```

#### [NEW] [Controllers/DocumentsController.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Web/Controllers/DocumentsController.cs)
Document CRUD with all 26 metadata fields:
```csharp
using Microsoft.AspNet.Identity;
using System;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Web;
using System.Web.Mvc;
using System.Data.Entity;
using InEightDMS.Data;
using InEightDMS.Domain.Entities;
using InEightDMS.Web.Models;

namespace InEightDMS.Web.Controllers
{
    [Authorize]
    public class DocumentsController : Controller
    {
        private readonly DMSDbContext _context = new DMSDbContext();
        private readonly string _uploadPath = "~/App_Data/Uploads";
        
        public async Task<ActionResult> Index(int projectId)
        {
            var userId = User.Identity.GetUserId<int>();
            var hasAccess = await HasProjectAccessAsync(userId, projectId);
            
            if (!hasAccess)
                return HttpNotFound();
            
            var documents = await _context.Documents
                .Where(d => d.ProjectId == projectId)
                .Include(d => d.UploadedBy)
                .OrderByDescending(d => d.UploadedAt)
                .ToListAsync();
            
            ViewBag.ProjectId = projectId;
            return View(documents);
        }
        
        [HttpGet]
        public ActionResult Create(int projectId)
        {
            ViewBag.ProjectId = projectId;
            ViewBag.DocumentTypes = GetDocumentTypes();
            ViewBag.Statuses = GetDocumentStatuses();
            return View();
        }
        
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> Create(DocumentCreateViewModel model, HttpPostedFileBase file)
        {
            if (!ModelState.IsValid)
            {
                ViewBag.ProjectId = model.ProjectId;
                ViewBag.DocumentTypes = GetDocumentTypes();
                ViewBag.Statuses = GetDocumentStatuses();
                return View(model);
            }
            
            var userId = User.Identity.GetUserId<int>();
            
            // Handle file upload
            string filePath = null;
            if (file != null && file.ContentLength > 0)
            {
                var uploadDir = Server.MapPath(_uploadPath);
                Directory.CreateDirectory(uploadDir);
                
                var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.FileName)}";
                filePath = Path.Combine(uploadDir, fileName);
                file.SaveAs(filePath);
                filePath = fileName; // Store relative path
            }
            
            var document = new Document
            {
                ProjectId = model.ProjectId,
                Name = model.Name,
                Description = model.Description,
                Type = model.Type,
                Category = model.Category,
                Tags = model.Tags,
                Status = DocumentStatus.Draft,
                UploadedById = userId,
                UploadedAt = DateTime.UtcNow,
                FilePath = filePath
            };
            
            _context.Documents.Add(document);
            await _context.SaveChangesAsync();
            
            // Log action
            _context.DocumentActions.Add(new DocumentAction
            {
                DocumentId = document.Id,
                Type = ActionType.Created,
                ActionById = userId,
                Details = $"{{\"name\":\"{document.Name}\"}}"
            });
            await _context.SaveChangesAsync();
            
            return RedirectToAction(nameof(Index), new { projectId = model.ProjectId });
        }
        
        public async Task<ActionResult> Details(int id)
        {
            var document = await _context.Documents
                .Include(d => d.UploadedBy)
                .Include(d => d.Project)
                .Include(d => d.LinkedItems)
                .Include(d => d.Actions)
                .FirstOrDefaultAsync(d => d.Id == id);
            
            if (document == null)
                return HttpNotFound();
            
            return View(document);
        }
        
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> AddLinkedItem(LinkedItemViewModel model)
        {
            var userId = User.Identity.GetUserId<int>();
            
            var linkedItem = new LinkedItem
            {
                DocumentId = model.DocumentId,
                ItemType = model.ItemType,
                Status = ItemStatus.Open,
                ItemNumber = model.ItemNumber,
                Title = model.Title,
                CreatedById = userId
            };
            
            _context.LinkedItems.Add(linkedItem);
            await _context.SaveChangesAsync();
            
            return RedirectToAction(nameof(Details), new { id = model.DocumentId });
        }
        
        private async Task<bool> HasProjectAccessAsync(int userId, int projectId)
        {
            var user = await _context.Users.FindAsync(userId);
            
            if (user.Role == UserRole.Admin)
                return true;
            
            return await _context.ProjectUsers
                .AnyAsync(pu => pu.UserId == userId && pu.ProjectId == projectId)
                || await _context.Projects
                .AnyAsync(p => p.Id == projectId && p.ManagerId == userId);
        }
        
        private SelectList GetDocumentTypes()
        {
            return new SelectList(new[] { "IFC", "DWG", "PDF", "DOCX", "XLSX", "Other" });
        }
        
        private SelectList GetDocumentStatuses()
        {
            return new SelectList(Enum.GetValues(typeof(DocumentStatus)));
        }
        
        protected override void Dispose(bool disposing)
        {
            if (disposing) _context.Dispose();
            base.Dispose(disposing);
        }
    }
}
```

#### [NEW] [Views/Shared/_Layout.cshtml](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Web/Views/Shared/_Layout.cshtml)
Modern UI with Bootstrap 5:
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - InEight DMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="~/Content/Site.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">InEight DMS</a>
            <div class="navbar-nav ms-auto">
                @if (Request.IsAuthenticated)
                {
                    <span class="navbar-text me-3">@User.Identity.Name</span>
                    @using (Html.BeginForm("LogOff", "Account", FormMethod.Post))
                    {
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-outline-light btn-sm">Logout</button>
                    }
                }
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        @RenderBody()
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("scripts", required: false)
</body>
</html>
```

---

### Phase 5: Database Migrations (EF6 Code First)

#### [RUN] Enable & Run Migrations
```powershell
# In Package Manager Console (InEightDMS.Data project)
Enable-Migrations -ContextTypeName InEightDMS.Data.DMSDbContext

Add-Migration InitialCreate

Update-Database
```

#### [NEW] [Migrations/Configuration.cs](file:///d:/Code/ineight/projects/InEightDocumentAISuite/InEightDMS/InEightDMS.Data/Migrations/Configuration.cs)
Seed initial data:
```csharp
using System.Data.Entity.Migrations;
using InEightDMS.Domain.Entities;
using Microsoft.AspNet.Identity;
using Microsoft.AspNet.Identity.EntityFramework;

namespace InEightDMS.Data.Migrations
{
    internal sealed class Configuration : DbMigrationsConfiguration<DMSDbContext>
    {
        public Configuration()
        {
            AutomaticMigrationsEnabled = false;
        }

        protected override void Seed(DMSDbContext context)
        {
            // Create Admin user if not exists
            var userManager = new UserManager<ApplicationUser, int>(
                new UserStore<ApplicationUser, ApplicationRole, int, 
                    ApplicationUserLogin, ApplicationUserRole, ApplicationUserClaim>(context));
            
            if (userManager.FindByEmail("admin@abc-organization.com") == null)
            {
                var admin = new ApplicationUser
                {
                    UserName = "admin@abc-organization.com",
                    Email = "admin@abc-organization.com",
                    Name = "System Administrator",
                    Role = UserRole.Admin,
                    EmailConfirmed = true
                };
                userManager.Create(admin, "Admin@123");
            }
        }
    }
}
```

---

### Phase 6: Role-Based Access Control Matrix

| Feature | Admin | Project Manager | Project User |
|---------|-------|-----------------|--------------|
| Register Users | ❌ System Only | ❌ | ❌ |
| Create Projects | ✅ | ❌ | ❌ |
| Assign Project Manager | ✅ | ❌ | ❌ |
| Add Users to Project | ❌ | ✅ (Own Project) | ❌ |
| Upload Documents | ❌ | ✅ (Own Project) | ✅ (Assigned Project) |
| View Documents | ✅ (All) | ✅ (Own Project) | ✅ (Assigned Project) |
| Edit Document Metadata | ❌ | ✅ (Own Project) | ✅ (Assigned Project) |
| Approve Documents | ❌ | ✅ (Own Project) | ❌ |
| Delete Documents | ❌ | ✅ (Own Project) | ❌ |
| Add Linked Items (RFI/Transmittal) | ❌ | ✅ | ✅ |
| View Chatbot Usage | ✅ (All Users) | ✅ (Project Users) | ❌ |

---

## Verification Plan

### Manual Verification

#### 1. Project Setup
1. Open solution in Visual Studio 2022
2. Build solution (Ctrl+Shift+B)
3. Run migrations via Package Manager Console
4. Press F5 to run application

#### 2. User Registration & Login
1. Navigate to `/Account/Register`
2. Register as Project Manager with email `m1@abc-org.com`
3. Login and verify redirect to Dashboard

#### 3. Admin Workflow
1. Login as Admin (`admin@abc-organization.com` / `Admin@123`)
2. Navigate to Projects → Create
3. Create new project "Project D" with Manager M1
4. Verify project appears in list

#### 4. Document Upload
1. Login as Manager M1
2. Navigate to Project D → Documents
3. Upload a document with all metadata fields
4. Verify document appears in list with correct metadata

#### 5. Linked Items
1. Open document details
2. Add RFI linked item with number "RFI-2024-001"
3. Verify RFI appears in document details

---

## Implementation Timeline

### Week 1: Foundation
- Day 1-2: Solution setup in Visual Studio, project structure
- Day 3: Domain models (all entities with EF6 conventions)
- Day 4: DbContext, Fluent API configuration
- Day 5: ASP.NET Identity setup

### Week 2: Core Features
- Day 1: Authentication (Login/Register with Identity)
- Day 2: Project CRUD (Admin only)
- Day 3: User management, project assignment
- Day 4: Document CRUD with all 26 fields
- Day 5: File upload to local App_Data

### Week 3: Advanced Features
- Day 1: Linked Items (RFI, Transmittal, etc.)
- Day 2: Document Actions tracking
- Day 3: Document revision history
- Day 4: Approval workflow UI
- Day 5: Testing & bug fixes

### Week 4: UI & Polish
- Day 1-2: Views with Bootstrap 5
- Day 3: Sample data seeding
- Day 4: Integration testing
- Day 5: Final testing & documentation

---

## Success Criteria

✅ Solution builds successfully on .NET Framework 4.8.1
✅ Admin can create projects and assign managers
✅ Project Managers can add users and upload documents
✅ Project Users can only access assigned projects
✅ All 26 document metadata fields are captured
✅ Linked Items (RFI, Transmittal, Mail, Forms, Tasks) work correctly
✅ Document Actions are logged
✅ File upload works (local App_Data storage)
✅ Role-based access control is enforced
✅ ASP.NET Identity authentication works

---

## Connection to AI Chatbot

After DMS implementation, the AI Chatbot (covered in `4.1 Implementation_plan.md`) will:
1. Connect to the DMS SQL Server database via connection string or Hybrid Connection
2. Sync document metadata to the vector store (pgvector or Azure AI Search)
3. Respect user access permissions when querying
4. Return links to documents and filtered views

The DMS provides the **data foundation** that the AI Chatbot queries using natural language.
